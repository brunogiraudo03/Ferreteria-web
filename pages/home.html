<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⚙️ Ferretería   - Inicio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../static/style.css">
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
        <div class="container">
            <a class="navbar-brand text-danger fw-bold" href="home.html">⚙️ Ferretería  </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto gap-2 align-items-center">
                    <li class="nav-item">
                        <button id="btn-backup" class="btn btn-sm btn-outline-light" title="Descargar copia de seguridad">
                            <i class="bi bi-download me-1"></i> Backup
                        </button>
                    </li>
                    <li class="nav-item">
                        <input type="file" id="input-import" accept=".json" style="display: none;">
                        <button id="btn-import-trigger" class="btn btn-sm btn-outline-success" title="Restaurar copia guardada">
                            <i class="bi bi-upload me-1"></i> Restaurar
                        </button>
                    </li>
                    <li class="nav-item">
                        <button id="btn-delete-all" class="btn btn-sm btn-outline-danger" title="Borrar toda la base de datos">
                            <i class="bi bi-trash3-fill me-1"></i> Borrar Todo
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <header class="hero-section">
        <div class="hero-overlay"></div>
        <div class="container text-center text-white hero-text">
            <h1 class="display-3 fw-bold">Ferretería  </h1>
            <p class="lead fs-3">Tu sistema de gestión de confianza</p>
            <div id="status-msg" class="mt-2 fw-bold" style="min-height: 24px;"></div>
        </div>
    </header>

    <main class="container mt-5 mb-5">
        <div class="row g-4 justify-content-center">
            
            <div class="col-md-4">
                <div class="card nav-card h-100 shadow-lg">
                    <div class="card-body text-center">
                        <i class="bi bi-cash-coin display-2 text-danger"></i>
                        <h5 class="card-title mt-3">Gestión de Caja</h5>
                        <p class="card-text">Controlá los ingresos, egresos y el balance diario de tu negocio.</p>
                        <a href="caja/caja_table.html" class="btn btn-danger">Ir a Caja</a>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card nav-card h-100 shadow-lg">
                    <div class="card-body text-center">
                        <i class="bi bi-people-fill display-2 text-danger"></i>
                        <h5 class="card-title mt-3">Cuentas Corrientes</h5>
                        <p class="card-text">Administrá los saldos y movimientos de las cuentas de tus clientes.</p>
                        <a href="clientes/clientes.html" class="btn btn-danger">Ir a Clientes</a>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card nav-card h-100 shadow-lg">
                    <div class="card-body text-center">
                        <i class="bi bi-truck display-2 text-danger"></i>
                        <h5 class="card-title mt-3">Gestión de Proveedores</h5>
                        <p class="card-text">Llevá un registro de las cuentas corrientes y pagos a proveedores.</p>
                        <a href="proveedores/proveedores.html" class="btn btn-danger">Ir a Proveedores</a>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card nav-card h-100 shadow-lg">
                    <div class="card-body text-center">
                        <i class="bi bi-wallet-fill display-2 text-danger"></i>
                        <h5 class="card-title mt-3">Cheques</h5>
                        <p class="card-text">Administra todos los cheques.</p>
                        <a href="cheques.html" class="btn btn-danger">Ir a Cheques</a>
                    </div>
                </div>
            </div>

             <div class="col-md-4">
                <div class="card nav-card h-100 shadow-lg">
                    <div class="card-body text-center">
                        <i class="bi bi-calculator-fill display-2 text-danger"></i>
                        <h5 class="card-title mt-3">Presupuestos</h5>
                        <p class="card-text">Crea y administra todos los presupuestos.</p>
                        <a href="presupuesto.html" class="btn btn-danger">Ir a Presupuesto</a>
                    </div>
                </div>
            </div>
            
        </div>
    </main>
    
    <footer class="bg-dark text-white text-center p-3 mt-auto">
        <p class="mb-0">&copy; 2025 Bruno  . Todos los derechos reservados.</p>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- CONFIGURACIÓN FIREBASE (Copia exacta de tu config actual) ---
        const firebaseConfig = {
        apiKey: "AIzaSyCxZXeMBFCnojOyrklKmPs-drk276eRDcs",
        authDomain: "ferreteria-giraudo-demo.firebaseapp.com",
        projectId: "ferreteria-giraudo-demo",
        storageBucket: "ferreteria-giraudo-demo.firebasestorage.app",
        messagingSenderId: "868547712282",
        appId: "1:868547712282:web:3318bfd50a61212e6648a3"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        // Habilitar persistencia (Importante para tu uso en local)
        firebase.firestore().enablePersistence()
            .catch((err) => {
                console.warn("Persistencia:", err.code);
            });

        const db = firebase.firestore();

        // --- LÓGICA DE BACKUP / RESTAURAR / BORRAR ---
        
        // Colecciones a gestionar
        const COLECCIONES = [
            'clientes', 
            'proveedores', 
            'caja',          
            'cheques', 
            'movimientos',   
            'movimientos_proveedor'
            // 'movimientos_caja' // Descomentar si implementas el historial en Firebase
        ];

        const statusMsg = document.getElementById('status-msg');

        // 1. EXPORTAR (BACKUP)
        document.getElementById('btn-backup').addEventListener('click', async () => {
            if(!confirm("¿Descargar copia de seguridad de TODOS los datos?")) return;
            
            statusMsg.textContent = "Generando backup... Espere.";
            statusMsg.style.color = "#ffc107"; // Amarillo
            
            const backupData = {};

            try {
                for (const colName of COLECCIONES) {
                    const snapshot = await db.collection(colName).get();
                    backupData[colName] = {};
                    snapshot.forEach(doc => {
                        backupData[colName][doc.id] = doc.data();
                    });
                }

                const dataStr = JSON.stringify(backupData, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                const fecha = new Date().toLocaleDateString('es-AR').replace(/\//g, '-');
                a.download = `Respaldo_Ferreteria_${fecha}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                statusMsg.textContent = "¡Copia descargada correctamente!";
                statusMsg.style.color = "#198754"; // Verde

            } catch (error) {
                console.error(error);
                statusMsg.textContent = "Error: " + error.message;
                statusMsg.style.color = "#dc3545"; // Rojo
            }
        });

        // 2. BORRAR BASE DE DATOS
document.getElementById('btn-delete-all').addEventListener('click', async () => {
            // Primer aviso
            const confirm1 = confirm("⚠️ ¡PELIGRO! ⚠️\n\nEsto borrará PERMANENTEMENTE todos los datos de la nube.\n\n¿Está seguro?");
            if (!confirm1) return;

            // Segundo aviso: Escribir palabra clave
            const palabraClave = prompt("SEGURIDAD MÁXIMA\n\nPara confirmar el borrado, escriba la palabra: ELIMINAR\n(En mayúsculas)");
            
            // Verificamos si escribió exactamente "ELIMINAR"
            if (palabraClave !== "ELIMINAR") {
                alert("Palabra incorrecta. Operación cancelada.");
                return;
            }

            statusMsg.textContent = "Eliminando datos... NO CIERRE LA PÁGINA.";
            statusMsg.style.color = "#dc3545";

            try {
                for (const colName of COLECCIONES) {
                    const snapshot = await db.collection(colName).get();
                    if (snapshot.empty) continue;

                    const batch = db.batch();
                    snapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                }
                
                statusMsg.textContent = "Base de datos eliminada.";
                alert("Base de datos vacía. Ahora puede importar un respaldo limpio.");

            } catch (error) {
                console.error(error);
                statusMsg.textContent = "Error al eliminar: " + error.message;
            }
        });

        // 3. IMPORTAR (RESTAURAR)
        const inputImport = document.getElementById('input-import');
        const btnImportTrigger = document.getElementById('btn-import-trigger');

        btnImportTrigger.addEventListener('click', () => {
            if(!confirm("¿Desea restaurar un archivo de respaldo?")) return;
            inputImport.click();
        });

        inputImport.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    statusMsg.textContent = "Restaurando datos...";
                    statusMsg.style.color = "#0dcaf0"; // Cyan

                    const batch = db.batch();
                    let opCount = 0;

                    for (const colName of Object.keys(data)) {
                        const docs = data[colName];
                        for (const docId of Object.keys(docs)) {
                            const docData = docs[docId];
                            const docRef = db.collection(colName).doc(docId);
                            batch.set(docRef, docData);
                            opCount++;
                        }
                    }
                    
                    if(opCount > 450) {
                        alert("Advertencia: El archivo es muy grande. Es posible que algunos datos no se carguen si superan el límite de 500 operaciones.");
                    }

                    await batch.commit();
                    statusMsg.textContent = "¡Restauración completada!";
                    statusMsg.style.color = "#198754";
                    alert("Datos restaurados correctamente.");
                    inputImport.value = ''; 

                } catch (error) {
                    console.error(error);
                    alert("Error: " + error.message);
                    statusMsg.textContent = "Fallo en la restauración.";
                }
            };
            reader.readAsText(file);
        });
    </script>
</body>
</html>